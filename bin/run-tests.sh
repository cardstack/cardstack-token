#!/bin/bash

# Due to issue https://github.com/trufflesuite/ganache-cli/issues/359
# running all the tests usually causes testrpc to crash. Instead,
# run all the tests with separate testrpc instances. It's slower, but
# more consistent.

CURRENT_DIR=`pwd`
cd `dirname $0`
DIR=`pwd`

TEST_DIR="$DIR/../test"
TRUFFLE="$DIR/../node_modules/.bin/truffle"
BUILD="$DIR/../build"
TESTRPC="$DIR/../node_modules/.bin/ganache-cli"
TESTRPC_PID=""
SUITE_EXIT=0
OPT1=--account="0x4214fecc01d87f5d3559230db253d5935a4ebe1a024f4977b6f6effd8a29dbaf,1000000000000000000000000"
OPT2=--account="0x0d7878ec27ddcc412d2ebec971191e99d81a91a40369fa878629aa4e3f5d8d21,100000000000000000000"
OPT3=--account="0x18f83cc4ecaa95d23d5c45deaf86a7c0be1c625c183a13c0ac56dfba8ada8a2d,100000000000000000000"
OPT4=--account="0x51b78b161754df3836b56741696cb1c5a4ece077dee6d645a8bd79b3f909e0be,100000000000000000000"
OPT5=--account="0x5d6af7022deb42d9d54cd76a55f9e8f24c710038557c2619e343a9899a3bfd65,100000000000000000000"
OPT6=--account="0x7739672ccf4cfaa17a5bd59f59dc1e8156b714191d4fdcd671ca4bc005dba80a,100000000000000000000"
OPT7=--account="0xcd7346e90d43ef02eea94d5652bb56c8523e7b09d0f6cfef228061884cb6ed61,100000000000000000000"
OPT8=--account="0x806257be5fb3e3b63c73da1a6694231c43db92c5490c0a64f734acf2a80f891c,100000000000000000000"
OPT9=--account="0x627d21c0faa0acb2243acf2a0eaac1bb9353a762f65d33d00943d3c51930e6b0,100000000000000000000"
OPT10=--account="0xf401c7170d55f6fe2a825cf1ce3bad978b3368d8bfcbe5e176b0868428373b4b,100000000000000000000"
OPT11=--account="0xeb5c18531a02ea83eab89b22eee7e2151a3058b10032b6fd27bd758ec3155526,100000000000000000000"
OPT12=--account="0x2b7a2f17825d81156bc1ad81b5b27a134ee838833c21b3d1dfa0536c29607eaa,100000000000000000000"
OPT13=--account="0xb267d6e53de614c0938db983a8ba7a71d64f086ed2b987cdece5e0a99852849d,100000000000000000000"
OPT14=--account="0x544f16e09741c3f2235d89bd68074618b9fece624c07c12f777c73534aa13cc2,100000000000000000000"
OPT15=--account="0x8afde16ac2389e233988f326875fcb008654f6e8810b44f3d05f0a2028e466df,100000000000000000000"
OPT16=--account="0x4cdeae4a12d0bd2a889ada30b5ed315fe871b927b7482d2aed62fb58e3df2855,100000000000000000000"
OPT17=--account="0x18054e21801ec1910fadb19c12e985af4dfa9d0613797314a5103477749349a1,100000000000000000000"
OPT18=--account="0x058284ec2d7867f1927840867e3c76749e5c4055e35e170d52b7ecdb191e25a7,100000000000000000000"
OPT19=--account="0xf44d63499c553d663384ea436673a872c835ee67b64aad7dc37a215b3435d26c,100000000000000000000"
OPT20=--account="0x7e64b4c395b73684a1bb443d993e743bae1f4b83a7eff94e9551e490b2141d9f,100000000000000000000"
OPT21=--account="0xa54c95fb5154d4b5f92f65afb05de3bb52a1c60d619f62d385cb7040e035b8e0,100000000000000000000"
OPT22=--account="0x7e0dc45fd9519749a1d6dc772ae630a74ff7e433544fd7026f898a89646ebb97,100000000000000000000"
OPT23=--account="0x9857f25bac59467992295d38d7e519b544979eb4a5781568cb60dd2259adc47e,100000000000000000000"
OPT24=--account="0xecb692afa96ea349ad4736aa3a1dab5ec6a5e3fdfed2d2f9ad124d678c6c9338,100000000000000000000"
OPT25=--account="0xc8fc04a2ac1795a17258ad280447cd48f79631ece23f49ca3f8406a88c119cc8,100000000000000000000"
OPT26=--account="0x6f3a72c0190f3032c3868c9b2a6852f6c3f4900afc64e0679a779dfd9864a362,100000000000000000000"
OPT27=--account="0x14d01e6525fa0cda85ab44b77962a56de8c04b61e1f701b5e05b42bb0cc16158,100000000000000000000"
OPT28=--account="0xac451a58faec2212a5d735135c180eb85a08256f68306a322618dac679c79612,100000000000000000000"
OPT29=--account="0x691fab28cac41f9d90fd55583e46e01d0a30504cd59bc994f166bd8b9fd98f1f,100000000000000000000"
OPT30=--account="0x1276a37be67e0d275dbacfaf7d1696856d57c67138db9c03bf209d2e79fb996d,100000000000000000000"
OPT31=--account="0x921644b68906b497dbc462d69973adfbb1f00f5759359c11e471f74414543928,100000000000000000000"
OPT32=--account="0x964d4f1e44ec23a7f72eb2b47e7fdeecc5d325d63fb469a36a63537aa4040a0c,100000000000000000000"
OPT33=--account="0xab27c218f960fb5b7611232dbae49b266fcbb481143ad2b8507bdf3e1893b92e,100000000000000000000"
OPT34=--account="0x8fac47743467c90b43dde06db463db9fc60978c254eea8544678cd5247ea7b5a,100000000000000000000"
OPT35=--account="0x94a08b727ba6c99ffb9b1607508a2573a9615d173e3b376437ff7414355fa3be,100000000000000000000"
OPT36=--account="0x475dafb6945b31adb0329c127fced49d2a266d8f933e44375fd8ef623e9cee8f,100000000000000000000"
OPT37=--account="0x5bbb2a6ed5854cef27753ad1909365d36bafbc60124225677d9ab92953554410,100000000000000000000"
OPT38=--account="0x601e11bbcfce0b3640e35f69a23dafe0bac1a9587c8d12d9bc5d29d05521d71b,100000000000000000000"
OPT39=--account="0x99c8b467c336012669766dc7924b9c43be2a0a2ebb28a305c0176cdaec09dcbb,100000000000000000000"
OPT40=--account="0xcf899b031411d305158bb4af10e97b0af6362d468ece6601e91b44e1d543630f,100000000000000000000"
OPT41=--account="0x051d218f60ba0431fe6478d5976459a80a3162f2bd3f935e8dc079b7304ab76e,100000000000000000000"
OPT42=--account="0x6e7dcb217dc10a19d905b802f3beea231639bc4072c4b2afeb9b2e775d0c67d2,100000000000000000000"
OPT43=--account="0xb8e983ca3ce47eec836f2370aebb40b415e261e9e1604281b0fb587e92f87f58,100000000000000000000"
OPT44=--account="0xd6408e06542a4f1503bbdd7fe5d5a2fb45d79040c97f5e68253f73f944aa9380,100000000000000000000"
OPT45=--account="0x4e396f7f1e04ac2894e55f0d08a645b54dd4cdd59cbcee094b76f33133b6c5b9,100000000000000000000"
OPT46=--account="0x1f0941fa8da1f9f8660cef1099e2fde21b441fbb24a5d8bf216e3d3c8f0d2a2f,100000000000000000000"
OPT47=--account="0xfe52ce2ef9f94d98786aa06a1df3f15c72a2a6d1d1ea1bec72c31d72e529fff5,100000000000000000000"
OPT48=--account="0xbf9a2048901090c3f70defbf53af4d7d176e1399834f3c4aabd70a29a68bef63,100000000000000000000"
OPT49=--account="0x7a72e9f3b1c9c2f312812500fe8e88de27f410ad1aa0cc46a465f4d7984358fb,100000000000000000000"
OPT50=--account="0xad0238822521d44c58eb60a80b9afcdc1dc4ee4cbb089a00b31720d5b9286c60,100000000000000000000"

rm -rf "$BUILD"

function finish {
  kill -9 $TESTRPC_PID
}

for filename in $TEST_DIR/*-test.js; do
  $TESTRPC --gasLimit 6100000 \
           $OPT1 \
           $OPT2 \
           $OPT3 \
           $OPT4 \
           $OPT5 \
           $OPT6 \
           $OPT7 \
           $OPT8 \
           $OPT9 \
           $OPT10 \
           $OPT11 \
           $OPT12 \
           $OPT13 \
           $OPT14 \
           $OPT15 \
           $OPT16 \
           $OPT17 \
           $OPT18 \
           $OPT19 \
           $OPT20 \
           $OPT21 \
           $OPT22 \
           $OPT23 \
           $OPT24 \
           $OPT25 \
           $OPT26 \
           $OPT27 \
           $OPT28 \
           $OPT29 \
           $OPT30 \
           $OPT31 \
           $OPT32 \
           $OPT33 \
           $OPT34 \
           $OPT35 \
           $OPT36 \
           $OPT37 \
           $OPT38 \
           $OPT39 \
           $OPT40 \
           $OPT41 \
           $OPT42 \
           $OPT43 \
           $OPT44 \
           $OPT45 \
           $OPT46 \
           $OPT47 \
           $OPT48 \
           $OPT49 \
           $OPT50 > /dev/null &
  TESTRPC_PID=$!
  $TRUFFLE test "$filename"
  TEST_EXIT=$?
  kill -9 $TESTRPC_PID > /dev/null 2>&1
  if [ $TEST_EXIT -ne 0 ]; then
    SUITE_EXIT=$TEST_EXIT
  fi
done

trap finish EXIT

if [ $SUITE_EXIT -ne 0 ]; then
  >&2 echo "Exiting with failing tests"
else
  echo "Tests passed"
fi
exit $SUITE_EXIT
